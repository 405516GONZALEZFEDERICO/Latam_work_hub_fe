<!-- Tarjeta de Completar Perfil -->
<div class="outer-container">
  <div class="profile-wrapper">
    <mat-card class="profile-card">
      <mat-card-content>
      
        
        <!-- Tabs -->
        <mat-tab-group mat-align-tabs="center" [(selectedIndex)]="activeTab" (selectedIndexChange)="setActiveTab($event)" animationDuration="0ms">
          <!-- Tab de Datos Personales -->
          <mat-tab>
            <ng-template mat-tab-label>
              <div class="d-flex align-items-center">
                <mat-icon class="me-2">person</mat-icon>
                <span>Datos personales</span>
              </div>
            </ng-template>
            
            <div class="tab-content">
              <!-- Mostrar el stepper de dirección o formulario de datos personales -->
              <div *ngIf="!showAddressStepper">
                <app-personal-data-form
                  (formSubmitted)="handleFormSubmitted($event)">
                </app-personal-data-form>
                
                <!-- Sección de dirección con un botón para abrir el stepper -->
                <div class="address-section">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="address-title">Dirección</h3>
                    <button mat-stroked-button color="primary" (click)="toggleAddressStepper()">
                      <mat-icon>add</mat-icon> Agregar dirección
                    </button>
                  </div>
                  
                  <!-- Mostrar la dirección guardada si existe -->
                  <div *ngIf="addressData" class="address-card">
                    <div class="address-info">
                      <p><strong>{{addressData.city.country.name}}, {{addressData.city.name}}</strong></p>
                      <p>{{addressData.streetName}} {{addressData.streetNumber}}</p>
                      <p *ngIf="addressData.floor || addressData.apartment">
                        Piso: {{addressData.floor || '-'}}, Depto: {{addressData.apartment || '-'}}
                      </p>
                      <p>CP: {{addressData.postalCode}}</p>
                    </div>
                    <button mat-icon-button color="primary" (click)="toggleAddressStepper()">
                      <mat-icon>edit</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Stepper de dirección -->
              <div *ngIf="showAddressStepper">
                <div class="address-stepper-header">
                  <button mat-icon-button (click)="toggleAddressStepper()">
                    <mat-icon>arrow_back</mat-icon>
                  </button>
                  <h2>Dirección</h2>
                </div>
                <app-address-stepper 
                  (addressSaved)="handleAddressSaved($event)">
                </app-address-stepper>
              </div>
            </div>
          </mat-tab>
          
          <!-- Tab de Empresa/Proveedor -->
          <mat-tab>
            <ng-template mat-tab-label>
              <div class="d-flex align-items-center">
                <mat-icon class="me-2">business</mat-icon>
                <!-- Mostrar etiqueta diferente según rol -->
                <span *ngIf="isProviderRole() && showProviderSelection">Tipo de Proveedor</span>
                <span *ngIf="!isProviderRole() || !showProviderSelection">Empresa</span>
              </div>
            </ng-template>
            
            <div class="tab-content">
              <!-- Flujo para proveedores - Selección de tipo (Individual/Empresa) -->
              <div *ngIf="isProviderRole() && showProviderSelection" class="provider-selection-wrapper">
                <app-provider-type-selection
                  [initialType]="providerType"
                  [userRole]="userData?.role || 'PROVEEDOR'"
                  (typeSelected)="handleProviderTypeSelection($event)"
                  (saved)="handleProviderTypeSaved()"
                  (back)="backToProviderSelection()">
                </app-provider-type-selection>
              </div>
              
              <!-- Flujo para empresa - Formulario de datos de empresa -->
              <div *ngIf="!showProviderSelection || !isProviderRole()" class="company-form-wrapper">
                <!-- Si es proveedor, mostrar botón de volver -->
                <app-company-form
                  *ngIf="isProviderRole()"
                  [userRole]="userData?.role || 'PROVEEDOR'"
                  (formSubmitted)="handleFormSubmitted($event)"
                  (back)="backToProviderSelection()">
                </app-company-form>
                
                <!-- Si es cliente, no mostrar botón de volver -->
                <app-company-form
                  *ngIf="!isProviderRole()"
                  [userRole]="userData?.role || 'CLIENTE'"
                  (formSubmitted)="handleFormSubmitted($event)">
                </app-company-form>
              </div>
              
              <!-- Mensaje informativo para roles no permitidos -->
              <div *ngIf="userData && userData.role !== 'PROVEEDOR' && userData.role !== 'CLIENTE'" class="alert alert-info mt-3">
                <p><strong>¡Atención!</strong> Esta sección puede requerir permisos adicionales.</p>
                <p>Tu rol actual es: {{ userData.role }}</p>
                <p>Si deberías tener acceso a esta sección, por favor contacta a soporte.</p>
              </div>
            </div>
          </mat-tab>
        </mat-tab-group>
      </mat-card-content>
    </mat-card>
  </div>
</div>
