<!-- Tarjeta de Completar Perfil -->
<div class="outer-container">
  <div class="profile-wrapper">
    <mat-card class="profile-card">
      <mat-card-content>
      
        
        <!-- Tabs -->
        <mat-tab-group mat-align-tabs="center" [(selectedIndex)]="activeTab" (selectedIndexChange)="setActiveTab($event)" animationDuration="0ms">
          <!-- Tab de Datos Personales -->
          <mat-tab>
            <ng-template mat-tab-label>
              <div class="d-flex align-items-center">
                <mat-icon class="me-2">person</mat-icon>
                <span>Datos personales</span>
              </div>
            </ng-template>
            
            <div class="tab-content">
              <!-- Mostrar el stepper de dirección o formulario de datos personales -->
              <div *ngIf="!showAddressStepper">
                <app-personal-data-form
                  (formSubmitted)="handleFormSubmitted($event)"
                  (profileDataLoaded)="handleProfileDataLoaded($event)">
                </app-personal-data-form>
                
                <!-- Sección de dirección con desplegable -->
                <div class="address-section">
                  <div class="address-header" (click)="toggleAddressSection()">
                    <div class="d-flex justify-content-between align-items-center">
                      <h3 class="address-title">Dirección</h3>
                      <mat-icon class="dropdown-icon" [class.rotated]="showAddressContent">keyboard_arrow_down</mat-icon>
                    </div>
                  </div>
                  
                  <!-- Contenido de dirección desplegable -->
                  <div class="address-content" [class.expanded]="showAddressContent">
                    <div class="address-actions" *ngIf="showAddressContent">
                      <!-- Solo mostrar el botón de agregar si NO hay dirección -->
                      <button *ngIf="!addressData && !isLoadingAddress" 
                              mat-stroked-button 
                              color="primary" 
                              (click)="toggleAddressStepper(false)">
                        <mat-icon>add</mat-icon> Agregar dirección
                      </button>
                    </div>
                    
                    <!-- Indicador de carga -->
                    <div *ngIf="isLoadingAddress" class="loading-container">
                      <mat-spinner diameter="40"></mat-spinner>
                    </div>
                    
                    <!-- Mostrar la dirección guardada si existe -->
                    <div *ngIf="addressData && !isLoadingAddress" class="address-card">
                      <div class="address-info">
                        <!-- Añadir logs para depuración de los datos -->
                        <p *ngIf="false">Debug: {{addressData | json}}</p>
                        
                        <!-- Usar operador de navegación segura para todas las propiedades -->
                        <p><strong>{{addressData?.city?.country?.name || 'País no disponible'}}, {{addressData?.city?.name || 'Ciudad no disponible'}}</strong></p>
                        <p>{{addressData?.streetName || 'Calle no disponible'}} {{addressData?.streetNumber || ''}}</p>
                        <p *ngIf="addressData?.floor || addressData?.apartment">
                          Piso: {{addressData?.floor || '-'}}, Depto: {{addressData?.apartment || '-'}}
                        </p>
                        <p>CP: {{addressData?.postalCode || 'CP no disponible'}}</p>
                      </div>
                      <button mat-icon-button color="primary" (click)="toggleAddressStepper(true)">
                        <mat-icon>edit</mat-icon>
                      </button>
                    </div>
                    
                    <!-- Mensaje cuando no hay dirección y no se está agregando una -->
                    <div *ngIf="!addressData && !showAddressStepper && !isLoadingAddress" class="empty-address-message">
                      <p>No has agregado ninguna dirección todavía.</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Stepper de dirección -->
              <div *ngIf="showAddressStepper">
                <div class="address-stepper-header">
                  <button mat-icon-button (click)="handleCancelAddress()">
                    <mat-icon>arrow_back</mat-icon>
                  </button>
                  <h2>{{ isEditingAddress ? 'Editar dirección' : 'Agregar dirección' }}</h2>
                </div>
                <app-address-stepper 
                  (addressSaved)="handleAddressSaved($event)"
                  (cancelled)="handleCancelAddress()"
                  [isEditMode]="isEditingAddress"
                  [existingAddress]="isEditingAddress && addressData ? addressData : undefined"
                  [userId]="currentUserId">
                </app-address-stepper>
              </div>
            </div>
          </mat-tab>
          
          <!-- Tab de Empresa/Proveedor -->
          <mat-tab>
            <ng-template mat-tab-label>
              <div class="d-flex align-items-center">
                <mat-icon class="me-2">business</mat-icon>
                <!-- Mostrar etiqueta diferente según rol -->
                <span *ngIf="isProviderRole() && showProviderSelection">Tipo de Proveedor</span>
                <span *ngIf="!isProviderRole() || !showProviderSelection">Empresa</span>
              </div>
            </ng-template>
            
            <div class="tab-content">
              <!-- Flujo para proveedores - Selección de tipo (Individual/Empresa) -->
              <div *ngIf="isProviderRole() && showProviderSelection" class="provider-selection-wrapper">
                <app-provider-type-selection
                  [userRole]="userData?.role || 'PROVEEDOR'"
                  (typeSelected)="handleProviderTypeSelection($event)"
                  (saved)="handleProviderTypeSaved()"
                  (back)="backToProviderSelection()">
                </app-provider-type-selection>
              </div>
              
              <!-- Flujo para empresa - Formulario de datos de empresa -->
              <div *ngIf="!showProviderSelection || !isProviderRole()" class="company-form-wrapper">
                <!-- Si es proveedor, mostrar botón de volver -->
                <app-company-form
                  *ngIf="isProviderRole()"
                  [userRole]="userData?.role || 'PROVEEDOR'"
                  [providerType]="providerType ? providerType : undefined"
                  (formSubmitted)="handleFormSubmitted($event)"
                  (back)="backToProviderSelection()">
                </app-company-form>
                
                <!-- Si es cliente, no mostrar botón de volver -->
                <app-company-form
                  *ngIf="!isProviderRole()"
                  [userRole]="userData?.role || 'CLIENTE'"
                  (formSubmitted)="handleFormSubmitted($event)">
                </app-company-form>
              </div>
              
            </div>
          </mat-tab>
        </mat-tab-group>
      </mat-card-content>
    </mat-card>
  </div>
</div>
